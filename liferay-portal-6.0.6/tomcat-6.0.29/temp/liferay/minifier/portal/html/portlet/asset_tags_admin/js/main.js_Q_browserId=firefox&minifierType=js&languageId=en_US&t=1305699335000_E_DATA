AUI().add("liferay-tags-admin",function(a){var b=a.Component.create({NAME:"assettagsadmin",EXTENDS:a.Base,constructor:function(){b.superclass.constructor.call(this)},prototype:{initializer:function(g){var c=this;var d=a.one(c._tagsContainerSelector);c.portletId=g;c._tagsAdminContainer=a.one(".tags-admin-container");a.all(".tag-close").on("click",function(){c._unselectAllTags();c._closeEditSection()});a.all(".tag-save-properties").on("click",function(){c._saveProperties()});c._portletMessageContainer=a.Node.create('<div class="lfr-message-response" id="tag-portlet-messages" />');c._tagMessageContainer=a.Node.create('<div class="lfr-message-response" id="tag-messages" />');c._portletMessageContainer.hide();c._tagMessageContainer.hide();c._tagsAdminContainer.placeBefore(c._portletMessageContainer);d.placeBefore(c._tagMessageContainer);var h=a.all(".tags-admin-toolbar");var f=a.one(".add-tag-layer");c._addTagOverlay=new a.OverlayContextPanel({align:{points:["tr","br"]},bodyContent:f,trigger:".add-tag-button"}).render();c._addTagOverlay.after("visibleChange",function(j){if(j.newVal){var i=f.one(".new-tag-name");Liferay.Util.focusFormField(i)}});a.one(".tag-permissions-button").on("click",function(){var j=c._selectedTagName;var k=c._selectedTagId;if(j&&k){var i=c._createPermissionURL("com.liferay.portlet.asset.model.AssetTag",j,k);submitForm(document.hrefFm,i.toString())}else{alert(Liferay.Language.get("please-first-select-a-tag"))}});var e=function(){var i=f.one(".new-tag-name");var j=(i&&i.val())||"";c._hideAllMessages();c._addTag(j)};a.one("input.tag-save-button").on("click",e);a.all(".tags-admin-actions input").on("keyup",function(j){if(j.keyCode==13){var i=j.currentTarget;e();j.halt()}});a.one("input.tag-delete-button").on("click",function(){if(confirm(Liferay.Language.get("are-you-sure-you-want-to-delete-this-tag"))){c._deleteTag(c._selectedTagId,function(k){var j=k.exception;if(!j){c._closeEditSection();c._hideToolbarOverlays();c._displayTags()}else{if(j.indexOf("auth.PrincipalException")>-1){var i=Liferay.Language.get("you-do-not-have-permission-to-access-the-requested-resource");c._sendMessage("error",i)}}})}});a.all(".close-panel").on("click",function(){c._hideToolbarOverlays()});a.all(".aui-overlay input[type=text]").on("keyup",function(j){var i=27;var k=j.keyCode;if(k==i){c._hideToolbarOverlays()}});c._loadData();c.after("drag:drag",c._afterDrag);c.after("drag:drophit",c._afterDragDrop);c.after("drag:enter",c._afterDragEnter);c.after("drag:exit",c._afterDragExit);c.after("drag:start",c._afterDragStart)},_addTag:function(e,h){var c=this;var f=c._getPermissionsEnabled("community");var g=c._getPermissionsEnabled("guest");var d=["java.lang.String","[Ljava.lang.String;","com.liferay.portal.service.ServiceContext"];Liferay.Service.Asset.AssetTag.addTag({name:e,properties:[],serviceContext:a.JSON.stringify({communityPermissions:f,guestPermissions:g,scopeGroupId:themeDisplay.getParentGroupId()}),serviceParameterTypes:a.JSON.stringify(d)},function(k){var j=k.exception;if(!j&&k.tagId){c._sendMessage("success",Liferay.Language.get("your-request-processed-successfully"));c._displayTags(function(){var l=c._selectTag(k.tagId);if(l){var m=l.get("region").top;a.one(c._tagsContainerSelector).set("scrollTop",m)}c._showSection(".tag-edit")});c._resetActionValues();c._hideToolbarOverlays();if(h){h(e)}}else{var i="";if(j.indexOf("DuplicateTagException")>-1){i=Liferay.Language.get("that-tag-already-exists")}else{if((j.indexOf("TagNameException")>-1)||(j.indexOf("AssetTagException")>-1)){i=Liferay.Language.get("one-of-your-fields-contains-invalid-characters")}else{if(j.indexOf("auth.PrincipalException")>-1){i=Liferay.Language.get("you-do-not-have-permission-to-access-the-requested-resource")}}}if(i){c._sendMessage("error",i)}}})},_addProperty:function(j,f,i){var d=this;var c=a.one("div.tag-property-row");if(c){var e=c.clone();var h=e.one(".property-key");var g=e.one(".property-value");if(h){h.val(f)}if(g){g.val(i)}j.placeAfter(e);e.show();if(!f&&!i){e.one("input").focus()}d._attachPropertyIconEvents(e)}},_afterDrag:function(d){var c=this;a.DD.DDM.syncActiveShims(true)},_afterDragDrop:function(f){var c=this;var d=f.drop.get("node");var e=f.target.get("node");d.removeClass("active-area");c._merge(e,d)},_afterDragEnter:function(e){var c=this;var d=e.drop.get("node");d.addClass("active-area")},_afterDragExit:function(e){var c=this;var d=e.drop.get("node");d.removeClass("active-area")},_afterDragStart:function(g){var c=this;var e=g.target;var d=e.get("dragNode");var f=e.get("node");var h=d.get("firstChild");if(!h){h=f.clone().empty();h.addClass("portlet-tags-admin-helper");d.appendChild(h)}h.html(f.html())},_alternateRows:function(){var c=this;var e=a.all(c._tagsContainerSelector);var d=e.all("li");d.removeClass("alt");d.odd().addClass("alt")},_attachPropertyIconEvents:function(f){var c=this;var d=f.one(".add-property");var e=f.one(".delete-property");if(d){d.on("click",function(){c._addProperty(f,"","")})}if(e){e.on("click",function(){c._removeProperty(f)})}},_buildProperties:function(){var c=this;var d=[];a.all(".tag-property-row").each(function(h,g,j){if(!h.hasClass("aui-helper-hidden")){var i=h.one("input.property-key");var e=h.one("input.property-value");if(i&&e){var f=[i.val(),":",e.val(),","].join("");d.push(f)}}});return d.join("")},_closeEditSection:function(){var c=this;c._hideSection(".tag-edit");a.all(c._tagsContainerCellsSelector).setStyle("width","auto")},_createPermissionURL:function(d,f,g){var c=this;var e=Liferay.PortletURL.createPermissionURL(c.portletId,d,f,g);return e},_deleteTag:function(d,e){var c=this;Liferay.Service.Asset.AssetTag.deleteTag({tagId:d},e)},_displayProperties:function(d){var c=this;c._getProperties(d,function(f){if(!f.length){f=[{key:"",value:""}]}var g=f.length;var e=a.all("div.tag-property-row").size();if(e>g){return}a.each(f,function(j,i,l){var k=a.all("div.tag-property-row");var m=k.size()-1;var h=k.item(m);c._addProperty(h,j.key,j.value)})})},_displayTags:function(e){var c=this;var d=a.one("#tag-messages");if(d){d.hide()}c._getTags(function(f){c._displayTagsImpl(f,e)})},_displayTagsImpl:function(f,h){var c=this;var d=[];var e=a.one(c._tagsContainerSelector);d.push("<ul>");a.each(f,function(j,i,k){d.push('<li class="tag-item results-row" ');d.push('data-tag="');d.push(j.name);d.push('" data-tagId="');d.push(j.tagId);d.push('"><span><a href="javascript:;">');d.push(j.name);d.push("</a></span>");d.push("</li>")});d.push("</ul>");if(!f.length){d=[];c._sendMessage("info",Liferay.Language.get("no-tags-were-found"),"#tag-messages",true)}e.html(d.join(""));c._reloadSearch();var g=a.all(c._tagsItemsSelector);g.on("click",function(j){var i=c._getTagId(j.currentTarget);c._selectTag(i);c._showSection(".tag-edit")});g.each(function(k,j,l){var i=new a.DD.Drag({bubbleTargets:c,node:k,target:true});i.plug(a.Plugin.DDProxy,{borderStyle:"0",moveOnEnd:false});i.plug(a.Plugin.DDConstrained,{constrain2node:e});i.plug(a.Plugin.DDNodeScroll,{node:e,scrollDelay:100});i.removeInvalid("a")});c._alternateRows();if(h){h()}},_getTag:function(d){var c=this;return a.one('li[data-tagId="'+d+'"]')},_getTagId:function(f){var d=this;var e=a.one(f);if(e){var c=e.attr("data-tagId")}return c},_getTagName:function(f){var d=this;var e=a.one(f);if(e){var c=e.attr("data-tag")}return c},_getPermissionsEnabled:function(f){var c=this;var d=[];var g=a.one(".tag-permissions-actions");var e=g.all("[name$="+f+"Permissions]");e.each(function(i,h,j){if(i.get("checked")){d.push(i.val())}});return d.join(",")},_getProperties:function(d,e){var c=this;Liferay.Service.Asset.AssetTagProperty.getTagProperties({tagId:d},e)},_getTags:function(d){var c=this;c._showLoading(c._tagsContainerSelector);Liferay.Service.Asset.AssetTag.getGroupTags({groupId:themeDisplay.getParentGroupId()},d)},_hideAllMessages:function(){var c=this;c._tagsAdminContainer.one(".lfr-message-response").hide()},_hideLoading:function(d){var c=this;c._tagsAdminContainer.one("div.loading-animation").remove()},_hideSection:function(f){var d=this;var e=a.one(f);if(e){var c=e.get("parentNode");if(c){c.hide()}}},_hideToolbarOverlays:function(){var c=this;c._addTagOverlay.hide()},_loadData:function(){var c=this;c._closeEditSection();c._displayTags(function(){c._getTagId(c._tagsItemsSelector)})},_merge:function(e,h){var k=this;var g=k._getTagId(e);var f=k._getTagName(e);var c=k._getTagId(h);var d=k._getTagName(h);var i=d;var j=Liferay.Language.get("are-you-sure-you-want-to-merge-x-into-x");j=a.substitute(j,[k._getTagName(e),i]);if(confirm(j)){k._mergeTags(g,c,function(){e.remove();k._selectTag(c);k._alternateRows()})}},_mergeTags:function(d,c,e){Liferay.Service.Asset.AssetTag.mergeTags({fromTagId:d,toTagId:c},e)},_reloadSearch:function(){var c=this;var d={data:function(e){return e.one("span a").html()},input:"#tags-admin-search-input",nodes:c._tagsItemsSelector};if(c.liveSearch){c.liveSearch.destroy()}c.liveSearch=new a.LiveSearch(d)},_removeProperty:function(d){var c=this;if(a.all("div.tag-property-row").size()>2){d.remove()}},_resetActionValues:function(){var c=this;a.all(".tags-admin-actions input[type=text]").val("")},_saveProperties:function(){var c=this;var f=c._selectedTagId;var g=a.one(".tag-edit input.tag-name");var e=(g&&g.val())||c._selectedTagName;var d=c._buildProperties();c._updateTag(f,e,d);c._displayTags()},_selectTag:function(g){var d=this;var c=d._getTag(g);var g=d._getTagId(c);var e=d._getTagName(c);d._selectedTagId=g;d._selectedTagName=e;if(!g){return c}d._unselectAllTags();c.addClass("selected");var h=a.one(".tag-edit");var f=h.one("input.tag-name");if(f){f.val(e)}d._displayProperties(g);d._selectedTag=c;return c},_sendMessage:function(e,f){var c=this;var d=c._portletMessageContainer;var g="portlet-msg-"+e;clearTimeout(c._messageTimeout);d.removeClass("portlet-msg-error portlet-msg-success");d.addClass(g);d.html(f);d.show();c._messageTimeout=setTimeout(function(){d.hide();c._addTagOverlay.refreshAlign()},7000)},_showLoading:function(d){var c=this;a.all(d).html('<div class="loading-animation" />')},_showSection:function(f){var d=this;var e=a.one(f);if(e){var c=e.get("parentNode");if(c){c.show();e.one("input").focus();a.all(d._tagsContainerCellsSelector).setStyle("width","50%")}}},_unselectAllTags:function(){var c=this;a.all(c._tagsItemsSelector).removeClass("selected");var d=a.all("div.tag-property-row");if(d.size()>1){d.each(function(f,e,g){if(e>0){f.remove()}})}},_updateTag:function(f,d,e,g){var c=this;Liferay.Service.Asset.AssetTag.updateTag({tagId:f,name:d,properties:e,serviceContext:null},function(j){var i=j.exception;if(!i){var k=c._selectedTag.one("> span > a");if(!k){k=c._selectedTag.one("> span")}if(k){c._selectedTag.attr("data-tag",d);k.text(d);c._closeEditSection()}}else{var h="";if(i.indexOf("auth.PrincipalException")>-1){h=Liferay.Language.get("you-do-not-have-permission-to-access-the-requested-resource")}else{if(i.indexOf("Exception")>-1){h=Liferay.Language.get("one-of-your-fields-contains-invalid-characters")}}if(h){c._sendMessage("error",h)}}if(g){g(j)}})},_selectedTag:null,_selectedTagName:null,_tagsContainerCellsSelector:".portlet-tags-admin .tags-admin-content td",_tagsContainerSelector:".tags",_tagsItemsSelector:".tags li"}});Liferay.Portlet.AssetTagsAdmin=b},"",{requires:["aui-live-search","aui-overlay-context-panel","base","dd","json","liferay-portlet-url","substitute"]});