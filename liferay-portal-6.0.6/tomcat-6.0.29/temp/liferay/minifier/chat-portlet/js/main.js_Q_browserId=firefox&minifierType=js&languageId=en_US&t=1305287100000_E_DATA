AUI().use("aui-base","delayed-task","liferay-poller","swfobject",function(a){Liferay.namespace("Chat");Liferay.Chat.Util={formatTime:function(e){var b=this;e=Number(e);e=new Date(e);var d="am";var c=e.getHours();var f=e.getMinutes();if(c>=11){d="pm"}if(c>12){c-=12}if(c==0){c+=12}if(f<10){f="0"+f}return c+":"+f+" "+d},getCurrentTimestamp:function(){var b=this;return(new Date()).getTime()},getUserImagePath:function(c){var b=this;return themeDisplay.getPathImage()+"/user_portrait?img_id="+c},TIMESTAMP_24:(24*60*60*1000)};Liferay.Chat.Panel=function(c){var b=this;if(!c.container){b._tabsContainer=Liferay.Chat.Manager.getContainer()}else{b._tabsContainer=a.one(c.container)}b._chatProperties={};b._eventsSuspended=false;b._panelId=c.panelId;b._panelTitle=c.panelTitle;b._panelIcon=c.panelIcon;b._created=Liferay.Chat.Util.getCurrentTimestamp();var d=b._setPanelHTML(c.panelHTML);b.set("panelHTML",d);b._createPanel(c.fromMarkup);if(c.panelTitle){b.setTitle(c.panelTitle)}b._popupTrigger.unselectable()};Liferay.Chat.Panel.prototype={close:function(){var b=this;b._panel.remove();b.fire("close")},getPanel:function(){var b=this;return b._panel},getTitle:function(){var b=this;return b._popupTitle.text()},hide:function(){var b=this;b.set("selected",false);b._panel.removeClass("selected");b.fire("hide")},resumeEvents:function(){var b=this;b._eventsSuspended=false},setTitle:function(c){var b=this;b._popupTrigger.one(".trigger-name").text(c);b._popupTitle.text(c)},show:function(){var b=this;b.set("selected",true);b._panel.addClass("selected");b.fire("show")},suspendEvents:function(){var b=this;b._eventsSuspended=true},toggle:function(){var b=this;if(b.get("selected")){b.hide()}else{b.show()}},_createPanel:function(d){var b=this;var c;var e="";if(d){c=a.one(d)}else{c=a.Node.create(b.get("panelHTML"))}b._popup=c.one(".chat-panel");b._popupTitle=c.one(".panel-title");b._textBox=c.one("textarea");b._popupTrigger=c.one(".panel-trigger");b._popupTrigger.on("click",b.toggle,b);c.all(".panel-button").on("click",function(f){var g=f.currentTarget;if(g.hasClass("minimize")){b.hide()}else{if(g.hasClass("close")){b.close()}}});b._panel=c;b._tabsContainer.append(c)},_setPanelHTML:function(c){var b=this;if(!c){c='<li class="panel"><div class="panel-trigger"><span class="trigger-name"></span></div><div class="chat-panel"><div class="panel-window"><div class="panel-button minimize"></div><div class="panel-title"></div><div class="panel-content"></div></div></div></li>'}return c}};a.augment(Liferay.Chat.Panel,a.Attribute);Liferay.Chat.Conversation=function(c){var b=this;Liferay.Chat.Conversation.superclass.constructor.call(b,c);b._chatInput=b._panel.one(".panel-input textarea");b._chatOutput=b._panel.one(".panel-output");b._statusMessage=b._panel.one(".panel-profile");b._created=Liferay.Chat.Util.getCurrentTimestamp();b._lastMessageTime=0;b._lastTypedTime=0;b._typingDelay=5000;b._unreadMessages=0;b._originalPageTitle=document.title;b._stopTypingTask=new a.DelayedTask(b.setTyping,b,[false]);b._heightMonitor=a.Node.create('<pre class="chat-height-monitor" />');b._heightMonitor.appendTo(document.body);b._unreadMessagesContainer=b._panel.one(".unread");if(!b._unreadMessagesContainer){b._unreadMessagesContainer=a.Node.create('<div class="unread" />');b._popupTrigger.append(b._unreadMessagesContainer)}if(c.statusMessage){b._statusMessage.text(c.statusMessage)}b._chatInput.on("keyup",b._keystroke,b);b._chatInput.on("focus",b._keystroke,b)};a.extend(Liferay.Chat.Conversation,Liferay.Chat.Panel,{send:function(c){var b=this;Liferay.Chat.Manager.send(c)},setAsRead:function(){var b=this;b._panel.removeClass("waiting");b._unreadMessagesContainer.hide();b._unreadMessages=0;b.set("lastReadTime",Liferay.Chat.Util.getCurrentTimestamp());document.title=b._originalPageTitle},setAsUnread:function(){var b=this;if(!b.get("selected")){var c=b._panel;c.addClass("waiting");if(b._unreadMessages>1){b._unreadMessagesContainer.text(b._unreadMessages);b._unreadMessagesContainer.show()}else{Liferay.Chat.Manager.triggerSound();b._unreadMessagesContainer.hide()}document.title=b._originalPageTitle+" - Unread messages ("+b._unreadMessages+")"}},setTyping:function(c){var b=this;if(c){b._panel.addClass("typing")}else{b._panel.removeClass("typing")}},show:function(){var b=this;Liferay.Chat.Panel.prototype.show.call(b);b.setAsRead();var c=b._chatOutput.getDOM();c.scrollTop=c.scrollHeight},update:function(c){var b=this;if(c.incoming&&!c.cache){if(c.content.length){if(!b.get("selected")){var d=b.get("lastReadTime")||0;if(d<c.createDate){b._unreadMessages++}}b.setAsUnread()}else{b.setTyping(true);b._stopTypingTask.delay(b._typingDelay)}}if(c.content.length){b._updateMessageWindow(c);b.setTyping(false)}if(c.statusMessage){b._statusMessage.text(c.statusMessage)}},updateStatus:function(c){var b=this;b._statusMessage.text(c)},_autoSize:function(){var d=this;var c=d._heightMonitor.getDOM();if(!d._chatInputWidth){d._chatInputWidth=d._chatInput.get("offsetWidth");d._heightMonitor.setStyle("width",d._chatInputWidth)}var e=d._chatInput.getDOM();var f=Liferay.Util.escapeHTML(e.value);var g=document.createTextNode(f);c.innerHTML="";c.appendChild(g);f=c.innerHTML;if(!f.length){f="&nbsp;&nbsp;"}if(Liferay.Browser.isIe()){f=f.replace(/\n/g,"<br />")}c.innerHTML=f;var b=Math.max(c.offsetHeight,14);b=Math.min(b,64);e.style.overflowY="auto";if(b!=d._lastHeight){d._lastHeight=b;e.style.height=b+"px";e.style.overflowY=(b==64)?"scroll":"hidden";e.parentNode.style.height=(b+5)+"px"}},_keystroke:function(g){var b=this;var c=b._chatInput;var h=b._chatOutput;var d=b._panelId;var c=b._chatInput.getDOM();var f=c.value.replace(/\n|\r/gim,"");if(g.type=="keyup"){if(b.get("typedTo")==d){var e=Liferay.Chat.Util.getCurrentTimestamp();if(e-b._lastTypedTime>b._typingDelay){b.send({toUserId:d,content:""});b._lastTypedTime=e}}b.set("typedTo",d)}if(g.keyCode==13&&!g.shiftKey&&f.length){b._sendChat(c.value);c.value=""}b._autoSize()},_sendChat:function(e){var b=this;var d=Liferay.Chat.Util.getCurrentTimestamp();var c=b._panelId;var f=Liferay.Util.escapeHTML(e);b.send({content:e,toUserId:c});b._updateMessageWindow({content:f,createDate:d})},_setPanelHTML:function(){var b=this;var d=Liferay.Chat.Util.getUserImagePath(b._panelIcon);var c='<li class="user user_'+b._panelId+'" panelId="'+b._panelId+'"><div class="panel-trigger"><span class="trigger-name"></span><div class="typing-status"></div></div><div class="chat-panel"><div class="panel-window"><div class="panel-button minimize"></div><div class="panel-button close"></div><img alt="" class="panel-icon" src="'+d+'" /><div class="panel-title">'+b._panelTitle+'</div><div class="panel-profile">...</div><div class="panel-output"></div><div class="panel-input"><textarea></textarea></div></div></div></li>';return c},_updateMessageWindow:function(g){var h=this;var b=h._chatOutput;var j="outgoing";var e=g.content;var c=g.incoming;var f=themeDisplay.getUserName();if(c){j="incoming";f=h._panelTitle}e=e.replace(/\n/g,"<br />");var i='<p class="blurb '+j+'"><b class="name">'+f+'</b><i class="date">'+Liferay.Chat.Util.formatTime(g.createDate)+'</i><span class="text">'+e+"</span>";"</p>";var d=b.getDOM();d.innerHTML+=i;h._lastMessageTime=g.createDate;setTimeout(function(){d.scrollTop=d.scrollHeight-d.clientHeight},1)}});Liferay.Chat.Manager={init:function(){var b=this;b._chatContainer=a.one("#chatBar");b._tabsContainer=b._chatContainer.one(".chat-tabs");b._activePanelId=a.one("#activePanelId").val()||"";b._portletId=a.one("#chatPortletId").val();b._closedChats={};b._created=Liferay.Chat.Util.getCurrentTimestamp();b._myStatus=b._chatContainer.one(".status-message");b._sendTask=new a.DelayedTask(b.send,b);b._saveSettingsDelay=100;b._sound=new SWFObject("/chat-portlet/alert.swf","alertsound","0","0","8");b._soundContainer=b._chatContainer.one(".chat-sound");b._updatePresenceTask=new a.DelayedTask(b._updatePresence,b);b._updatePresenceDelay=30000;b._updatePresenceTask.delay();Liferay.Poller.addListener(b._portletId,b._onPollerUpdate,b);Liferay.bind("sessionExpired",function(c){Liferay.Poller.removeListener(b._portletId);b._chatContainer.hide()});b._createBuddyListPanel();b._createSettingsPanel();Liferay.fire("chatPortletReady")},close:function(d){var b=this;if((d!="buddylist")&&(d!="settings")){var c=b._panels[d];if(c){c.close()}}},getContainer:function(){var b=this;return b._tabsContainer},send:function(c,d){var b=this;if(!c.updatePresence){b._updatePresenceTask.cancel()}Liferay.Poller.submitRequest(b._portletId,c,d);b._updatePresenceTask.delay(b._updatePresenceDelay)},show:function(d){var b=this;var c=b._panels[d];if(c){c.show()}},toggle:function(d){var b=this;var c=b._panels[d];if(c){c.toggle()}},triggerSound:function(){var b=this;if(b._playSound){b._sound.write(b._soundContainer.getDOM())}},_addChat:function(d,c){var b=this;b._chatSessions[d]=c},_addPanel:function(d,c){var b=this;b._panels[d]=c;c.on("close",b._onPanelClose,b);c.on("hide",b._onPanelHide,b);c.on("show",b._onPanelShow,b)},_createBuddyListPanel:function(){var b=this;var d=new Liferay.Chat.Panel({fromMarkup:".chat-tabs > .buddy-list",panelId:"buddylist"});b._addPanel("buddylist",d);b._onlineBuddies=d.getPanel().one(".online-users");if(b._onlineBuddies){var c=b._onlineBuddies;if(c){c.delegate("click",function(e){b._createChatFromUser(e.currentTarget)},"li")}}},_createChatFromUser:function(d){var b=this;var e;var g=b._buddies;var f=d;d=a.one(d);if(d){f=d.getAttribute("userId")}if(!isNaN(Number(f))){e=g[f];if(e){var c=b._chatSessions[f];if(!c){c=b._createChatSession(e)}c.show()}}},_createChatSession:function(e){var c=this;var g=e.userId;var d=new Liferay.Chat.Conversation({panelId:e.userId,panelTitle:e.fullName,panelIcon:e.portraitId,statusMessage:e.statusMessage});c._addChat(g,d);c._addPanel(g,d);if(c._entryCache&&c._entryCache[g]){var b=c._entryCache[g];for(var f in b){var h=b[f];d.update({cache:true,content:h.content,createDate:h.createDate,incoming:(h.fromUserId==g)})}}if(e.open){d.show()}return d},_createSettingsPanel:function(){var b=this;var e=new Liferay.Chat.Panel({fromMarkup:".chat-tabs > .chat-settings",panelId:"settings"});b._addPanel("settings",e);var c=e.getPanel();var d=c.one("#saveSettings");b._statusMessageObj=c.one("#statusMessage");b._onlineObj=c.one("#onlineStatus");b._playSoundObj=c.one("#playSound");b._statusMessage=b._statusMessageObj.val()||"";b._online=b._onlineObj.get("checked")?1:0;b._playSound=b._playSoundObj.get("checked")?1:0;d.on("click",b._updateSettings,b)},_getSettings:function(){var b=this;return{activePanelId:b._activePanelId,online:b._online,statusMessage:b._statusMessage,playSound:b._playSound}},_loadCache:function(e){var l=this;if(!l._entryCache){l._entryCache={}}if(!l._entryIds){l._entryIds=[0]}var c=l._entryCache;var k=l._entryIds;var b=themeDisplay.getUserId();var g=e.length;for(var d=0;d<g;d++){var j=e[d];var f=j.toUserId;if(f==b){f=j.fromUserId}if(!c[f]){c[f]={}}var h=c[f];if(j.content!=""){h[j.entryId]=j;k.push(j.entryId)}}},_isMessageNew:function(f,d){var c=this;var e=f.createDate;var g=c._created;var b=c._closedChats[d]||0;return(e>g&&e>b)},_onPanelClose:function(e){var b=this;var c=e.target;var d=c._panelId;delete b._panels[d];if(c instanceof Liferay.Chat.Conversation){delete b._chatSessions[d]}b._closedChats[d]=Liferay.Chat.Util.getCurrentTimestamp();b._activePanelId="";b._saveSettings()},_onPanelHide:function(d){var b=this;var c=d.target;b._activePanelId="";b._saveSettings()},_onPanelShow:function(e){var b=this;var c=e.target;for(var d in b._panels){if(b._panels[d]!=c){b._panels[d].hide()}}if(c instanceof Liferay.Chat.Conversation){c._chatInput.focus()}b._activePanelId=c._panelId;b._saveSettings()},_onPollerUpdate:function(d,c){var b=this;b._updateBuddies(d.buddies);if(b._cacheLoaded){b._updateConversations(d.entries)}if(d.initialRequest){b._loadCache(d.entries);if(b._activePanelId.length){var e=parseInt(b._activePanelId,10);if(!isNaN(e)){b._createChatFromUser(b._activePanelId)}}b._cacheLoaded=true}},_saveSettings:function(){var b=this;b._sendTask.delay(b._saveSettingsDelay,null,null,[b._getSettings()])},_updateBuddies:function(c){var n=this;var l=c||[];var k=l.length;var d=n._buddies;var b=n._chatSessions;n._onlineBuddiesCount=k;var e=[];for(var f=0;f<k;f++){var g=l[f];var h=d[g.userId];var m=b[g.userId];g.isTyping=false;if(m&&(!h||h.statusMessage!=g.statusMessage)){m.updateStatus(g.statusMessage)}d[g.userId]=g;var j=Liferay.Chat.Util.getUserImagePath(g.portraitId);e.push('<li class="active" userId="'+g.userId+'"><img alt="" src="'+j+'" /><div class="name">'+g.fullName+"</div></li>")}n._onlineBuddies.html(e.join(""));n._updateBuddyList();n.fire("updateBuddies",c)},_updateBuddyList:function(d){var b=this;var c=b._panels.buddylist;var e=c.getTitle();e=e.replace(/\(\d+\)/,"("+b._onlineBuddiesCount+")");c.setTitle(e)},_updateConversations:function(f){var n=this;var h=f.length;var b=themeDisplay.getUserId();var c=n._entryCache;var m=n._entryIds.join("|");for(var e=0;e<h;e++){var l=f[e];var k=(m.indexOf("|"+l.entryId)>-1);if(!k){var g=l.toUserId;var d=false;if(l.fromUserId!=b){g=l.fromUserId;d=true}var j=n._buddies[g];if(j&&d){var o=n._chatSessions[g];if(!o&&l.content&&n._isMessageNew(l,g)){o=n._createChatSession({portraitId:j.portraitId,userId:j.userId,fullName:j.fullName,statusMessage:j.statusMessage})}if(o){o.update({incoming:d,content:l.content,createDate:l.createDate,entryId:l.entryId,statusMessage:j.statusMessage})}}}}n._loadCache(f)},_updatePresence:function(){var b=this;b.send({updatePresence:true})},_updateSettings:function(){var b=this;var d=b._panels.settings;var c=d.getPanel();b._statusMessage=b._statusMessageObj.val();b._online=b._onlineObj.get("checked")?1:0;b._playSound=b._playSoundObj.get("checked")?1:0;b._activePanelId="";d.hide();b._saveSettings();c.addClass("saved");if(b._statusMessage){b._myStatus.html("You are <strong>"+Liferay.Util.escapeHTML(b._statusMessage)+"</strong>")}setTimeout(function(){c.removeClass("saved")},1500)},_buddies:{},_chatSessions:{},_entries:[],_panels:{},_settings:{}};a.augment(Liferay.Chat.Manager,a.Attribute,true);a.on("domready",Liferay.Chat.Manager.init,Liferay.Chat.Manager)});